---
layout: post
title: "服务端开发之我见"
comments: true
description: "服务端开发关键点，base C++"
keywords: "服务端开发、Linux、C++"
---

>### **俗话说：不会服务端的研究员不是好的前端工程师(☺)。先说说背景吧，在15年底，我们组唯一的一个服务端大牛跑路了，然后就是研究员当家。。。正好又赶上我这个项目全量上线，日活从500w增加到6kw。实话实说大牛的服务端写的还是挺好的，不过确实坑也挺多的。。。毕竟日请求25亿+次，后来就是被各个组无尽的追杀(QA、OP、流量组等等)，当时有些问题我也一下子解决不了，比如晚间高峰服务性能会下降，比如莫名其妙几个服务的结果整合会超时&重连超时，比如连接池的socket会莫名断开，比如服务不能返回正常结果而报警，比如服务在一些请求下大面积core掉。。。不一而足，不过一切都过去了，在经过近一年的痛苦折磨后，在16年Q4的自我总结中我写道：XX服务优化，Q4的报警为0次，可用性达到99.9999%**。

>### **写这篇文章的目的是想梳理一下服务端开发的整体流程，包括一些关键点(连接池、epoll、aio、线程池、等待队列、semaphore、管道、socket、重连器等)，当然这只是对于我的这个项目的理解(高并发、低延迟)，深知服务端博大精深，需要走的路还有很长，最后还会提及一些我对于服务端易跳坑处的个人浅见**。

大部分公司服务端底层都会有架构部大致写好的框架，我下面所列的点主要是由阅读我司底层源代码得来，也查阅了一些资料，这些点组合起来足以构成一个高可用性的服务端，只是对于不同的业务可能要进行按需调整，并且我会对这些点的原理稍加梳理，这样需要哪些点不需要哪些点也能了然于胸了，各位如果想深入的话还是请参见《UNP》和《APUE》。服务端是一个项目好不好的根本，一个稳定的服务也是我们这些搞算法的工作的前提。

* #### **socket**：

socket大家还是比较熟悉了，简单的说是为了实现网络间进程通信而设计，Unix/Linux端内核已经封装了socket，当申请了一个socket后，会返回该socket的句柄，我们可以像操作文件一样操作socket进行I/O，具体可以参见[socket的MAN](http://www.man7.org/linux/man-pages/man2/socket.2.html)，下面说一下客户端和服务端使用socket连接的方式：

客户端：

```c
char buf[1000];//要发送的数据
int len = 1000;//发送数据长度
hostent *svr_host = gethostbyname("www.baidu.com");//得到IP
struct sockaddr_in serv_addr;
serv_addr.sin_family = AF_INET;	
serv_addr.sin_addr = *((in_addr *) (svr_host->h_addr));
serv_addr.sin_port = htons(80);//绑定端口
int sock_fd = socket(AF_INET, SOCK_STREAM, 0);//创建一个socket
if (connect(sockfd, (sockaddr *) (&serverAdd), sizeof(serverAdd)) == -1) //连接socket
{
	printf("Connect failed: %s\n", strerror(errno));
	close(sockfd);
	return -1;
}
write(sockfd, buf, len);//发送数据
read(sockfd, buf, len);//读取数据
close(sockfd);//关闭socket
```

服务端：



**参考**:

---

* 1: Joachims T. Optimizing search engines using clickthrough data[C]//Proceedings of the eighth ACM SIGKDD international conference on Knowledge discovery and data mining. ACM, 2002: 133-142.

* 2： Chang C C, Lin C J. LIBSVM: a library for support vector machines[J]. ACM Transactions on Intelligent Systems and Technology (TIST), 2011, 2(3): 27.

* 3: Burges C J C. A tutorial on support vector machines for pattern recognition[J]. Data mining and knowledge discovery, 1998, 2(2): 121-167.



